<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工作任务管理</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            padding: 20px;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .module {
            background-color: rgba(255, 255, 255, 0.93);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            flex: 1;
            min-width: 300px;
            transition: transform 0.3s ease;
        }
        
        .module:hover {
            transform: translateY(-5px);
        }
        
        .module-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .module-title-text {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .module-title i {
            color: #3498db;
        }
        
        .clear-all-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
            white-space: nowrap;
        }
        
        .clear-all-btn:hover {
            background-color: #c0392b;
        }
        
        .input-area {
            display: flex;
            margin-bottom: 25px;
        }
        
        input, textarea, select {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px 0 0 12px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        textarea {
            height: 80px;
            resize: vertical;
            font-family: inherit;
            white-space: pre-wrap; /* 保留换行符 */
        }
        
        button {
            padding: 15px 25px;
            background: linear-gradient(to right, #3498db, #2ecc71);
            color: white;
            border: none;
            border-radius: 0 12px 12px 0;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        button:hover {
            background: linear-gradient(to right, #2980b9, #27ae60);
            transform: scale(1.03);
        }
        
        .task-item, .log-item {
            background-color: #f8f9fa;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
            position: relative;
        }
        
        .task-item:hover, .log-item:hover {
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        
        .task-content {
            flex: 1;
            display: flex;
            align-items: flex-start; /* 改为顶部对齐 */
            gap: 12px; /* 缩小间距 */
            min-width: 0; /* 防止内容溢出 */
            padding-right: 90px; /* 为删除按钮预留空间 */
        }
        
        .task-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 2px; /* 微调垂直位置 */
        }
        
        .task-text {
            font-size: 1.1rem;
            flex: 1;
            word-break: break-word;
            cursor: pointer;
            line-height: 1.4;
            max-width: 100%; /* 确保不会超出容器 */
        }
        
        .completed {
            text-decoration: line-through;
            color: #95a5a6;
        }
        
        .delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            flex-shrink: 0;
            width: auto; /* 改为自适应宽度 */
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap; /* 防止文字换行 */
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        /* 修改悬停效果：只轻微上浮，不需要上下移动 */
        .delete-btn:hover {
            background-color: #c0392b;
            transform: translateY(calc(-50% - 2px));
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .task-category {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 10px;
            flex-shrink: 0;
            margin-top: 2px; /* 微调垂直位置 */
        }
        
        .category-work {
            background-color: #3498db;
            color: white;
        }
        
        .category-life {
            background-color: #2ecc71;
            color: white;
        }
        
        .category-study {
            background-color: #9b59b6;
            color: white;
        }
        
        .log-date {
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 3px;
            font-size: 0.95rem;
            cursor: pointer;
        }
        
        .time-period {
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
            font-size: 1.1rem;
            cursor: pointer;
        }
        
        .log-content {
            color: #555;
            line-height: 1.5;
            word-break: break-word;
            white-space: pre-wrap; /* 保留换行符 */
            flex: 1;
            padding-right: 90px; /* 为删除按钮预留空间 */
        }
        
        .data-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .data-btn {
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .export-btn {
            background: linear-gradient(to right, #9b59b6, #e74c3c);
        }
        
        .export-btn:hover {
            background: linear-gradient(to right, #8e44ad, #c0392b);
            transform: scale(1.03);
        }
        
        .import-btn {
            background: linear-gradient(to right, #2ecc71, #3498db);
        }
        
        .import-btn:hover {
            background: linear-gradient(to right, #27ae60, #2980b9);
            transform: scale(1.03);
        }
        
        .signature {
            position: fixed;
            bottom: 20px;
            right: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            font-style: italic;
            padding: 8px 15px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            font-family: inherit;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #95a5a6;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .data-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .data-btn {
                width: 100%;
                max-width: 300px;
                justify-content: center;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .module-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .clear-all-btn {
                align-self: flex-end;
            }
            
            .log-content {
                padding-right: 80px;
            }
            
            .delete-btn {
                right: 10px;
                padding: 6px 12px;
                font-size: 0.85rem;
            }
            
            .task-content {
                padding-right: 80px;
                gap: 10px;
            }
            
            .task-checkbox {
                width: 20px;
                height: 20px;
            }
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .task-count, .log-count {
            background-color: #3498db;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .time-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .time-inputs input, .time-inputs select {
            border-radius: 12px;
            flex: 1;
            min-width: 150px;
        }
        
        #timePeriod {
            flex: 0.5;
        }
        
        #workContent {
            border-radius: 12px 12px 0 12px;
        }
        
        #addLogBtn {
            border-radius: 0 12px 12px 12px;
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .log-date-period {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .log-details {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
            cursor: pointer;
        }
        
        .import-note {
            font-size: 0.9rem;
            color: #666;
            text-align: center;
            margin-top: 10px;
            font-style: italic;
        }
        
        .category-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .category-option {
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            border: 2px solid transparent;
            background-color: #f0f0f0;
            color: #555;
            position: relative;
            overflow: hidden;
        }
        
        .category-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }
        
        .category-option.active {
            font-weight: bold;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        
        .category-option.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.2);
            z-index: 1;
        }
        
        .category-option.category-work.active {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .category-option.category-life.active {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }
        
        .category-option.category-study.active {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }
        
        .edit-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #3498db;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .edit-textarea {
            width: 100%;
            padding: 8px;
            border: 2px solid #3498db;
            border-radius: 6px;
            font-size: 1rem;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
        
        .edit-select {
            padding: 8px;
            border: 2px solid #3498db;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .save-edit-btn {
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 5px;
            transition: all 0.3s;
        }
        
        .save-edit-btn:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .cancel-edit-btn {
            background-color: #95a5a6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .cancel-edit-btn:hover {
            background-color: #7f8c8d;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .edit-controls {
            display: flex;
            margin-top: 10px;
        }
        
        .log-work {
            cursor: pointer;
        }
        
        .editing-mode {
            background-color: #fff9e6;
            border: 2px solid #f1c40f;
        }
        
        .log-item-inner {
            display: flex;
            width: 100%;
            position: relative;
        }
        
        .log-content-wrapper {
            flex: 1;
            padding-right: 90px;
        }
        
        .task-text-wrapper {
            flex: 1;
            min-width: 0; /* 确保文本容器可以缩小 */
        }
        
        .task-left-section {
            display: flex;
            align-items: flex-start;
            gap: 10px; /* 减小左侧元素的间距 */
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-tasks"></i> 个人任务管理器</h1>
            <p class="subtitle">高效规划每日任务，记录工作时间轨迹</p>
        </header>
        
        <div class="main-content">
            <!-- 模块一：任务管理 -->
            <section class="module">
                <div class="module-title">
                    <div class="module-title-text">
                        <i class="fas fa-list-check"></i> 今日任务
                    </div>
                    <button class="clear-all-btn" id="clearTasksBtn">
                        <i class="fas fa-trash"></i> 清除全部
                    </button>
                </div>
                
                <div class="category-selector" id="categorySelector">
                    <div class="category-option category-work active" data-category="work">工作</div>
                    <div class="category-option category-life" data-category="life">生活</div>
                    <div class="category-option category-study" data-category="study">学习</div>
                </div>
                
                <div class="input-area">
                    <input type="text" id="taskInput" placeholder="输入新的任务内容...">
                    <button id="addTaskBtn"><i class="fas fa-plus"></i> 添加任务</button>
                </div>
                
                <div id="taskList">
                    <!-- 任务列表将动态生成 -->
                    <div class="empty-state">暂无任务，添加你的第一个任务吧！</div>
                </div>
            </section>
            
            <!-- 模块二：时间记录 -->
            <section class="module">
                <div class="module-title">
                    <div class="module-title-text">
                        <i class="fas fa-clock"></i> 工作时间记录
                    </div>
                    <button class="clear-all-btn" id="clearLogsBtn">
                        <i class="fas fa-trash"></i> 清除全部
                    </button>
                </div>
                
                <div class="time-inputs">
                    <input type="date" id="logDate" value="">
                    <input type="text" id="timePeriod" placeholder="时间段 (如: 9:00-10:30)">
                    <input type="text" id="workContent" placeholder="在这段时间内完成了什么工作...">
                </div>
                
                <div class="input-area">
                    <textarea id="logInput" placeholder="可以详细描述工作内容..."></textarea>
                    <button id="addLogBtn"><i class="fas fa-clock"></i> 添加记录</button>
                </div>
                
                <div id="logList">
                    <!-- 时间记录将动态生成 -->
                    <div class="empty-state">暂无时间记录，开始记录你的工作时间吧！</div>
                </div>
            </section>
        </div>
        
        <!-- 数据控制 -->
        <div class="data-controls">
            <button class="data-btn export-btn" id="exportBtn">
                <i class="fas fa-file-excel"></i> 导出Excel数据
            </button>
            <button class="data-btn import-btn" id="importBtn">
                <i class="fas fa-file-import"></i> 导入Excel数据
            </button>
            <input type="file" id="importFile" accept=".xlsx,.xls" style="display: none;">
        </div>
        <p class="import-note">导入数据将覆盖当前所有任务和时间记录，请谨慎操作</p>
        
        <!-- 制作标签 -->
        <div class="signature">Monson制作</div>
    </div>

    <script>
        // DOM元素
        const taskInput = document.getElementById('taskInput');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const taskList = document.getElementById('taskList');
        const categorySelector = document.getElementById('categorySelector');
        
        const logDate = document.getElementById('logDate');
        const timePeriod = document.getElementById('timePeriod');
        const workContent = document.getElementById('workContent');
        const logInput = document.getElementById('logInput');
        const addLogBtn = document.getElementById('addLogBtn');
        const logList = document.getElementById('logList');
        
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const importFile = document.getElementById('importFile');
        const clearTasksBtn = document.getElementById('clearTasksBtn');
        const clearLogsBtn = document.getElementById('clearLogsBtn');
        
        // 从本地存储加载数据
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        let timeLogs = JSON.parse(localStorage.getItem('timeLogs')) || [];
        
        // 当前选中的分类
        let selectedCategory = 'work';
        
        // 设置日期输入框的默认值为今天
        function setDefaultDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            logDate.value = `${year}-${month}-${day}`;
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            setDefaultDate();
            renderTasks();
            renderLogs();
            
            // 添加任务事件
            addTaskBtn.addEventListener('click', addTask);
            taskInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTask();
            });
            
            // 添加时间记录事件
            addLogBtn.addEventListener('click', addLog);
            logInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) addLog();
            });
            
            // 数据导出导入事件
            exportBtn.addEventListener('click', exportToExcel);
            importBtn.addEventListener('click', () => importFile.click());
            importFile.addEventListener('change', importFromExcel);
            
            // 清除按钮事件
            clearTasksBtn.addEventListener('click', clearAllTasks);
            clearLogsBtn.addEventListener('click', clearAllLogs);
            
            // 监听日期变化，如果为空则重置为今天
            logDate.addEventListener('change', function() {
                if (!this.value) setDefaultDate();
            });
            
            // 分类选择器事件
            categorySelector.querySelectorAll('.category-option').forEach(option => {
                option.addEventListener('click', function() {
                    // 移除所有active类
                    categorySelector.querySelectorAll('.category-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    // 为当前选项添加active类
                    this.classList.add('active');
                    selectedCategory = this.getAttribute('data-category');
                });
            });
        });
        
        // 添加新任务
        function addTask() {
            const text = taskInput.value.trim();
            if (!text) {
                alert('请输入任务内容');
                return;
            }
            
            const newTask = {
                id: Date.now(),
                text: text,
                category: selectedCategory,
                completed: false,
                createdAt: new Date().toISOString()
            };
            
            tasks.push(newTask);
            saveTasks();
            renderTasks();
            taskInput.value = '';
            taskInput.focus();
        }
        
        // 添加时间记录
        function addLog() {
            const date = logDate.value;
            const period = timePeriod.value.trim();
            const content = workContent.value.trim();
            const details = logInput.value; // 保留换行符，不trim
            
            if (!date || !period || !content) {
                alert('请填写日期、时间段和工作内容');
                return;
            }
            
            // 格式化日期显示
            const dateObj = new Date(date);
            const formattedDate = dateObj.toLocaleDateString('zh-CN', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'short'
            });
            
            const newLog = {
                id: Date.now(),
                date: date,
                formattedDate: formattedDate,
                period: period,
                content: content,
                details: details,
                createdAt: new Date().toISOString()
            };
            
            timeLogs.push(newLog);
            saveLogs();
            renderLogs();
            
            // 清空输入框（日期保留为今天）
            timePeriod.value = '';
            workContent.value = '';
            logInput.value = '';
            setDefaultDate();
            timePeriod.focus();
        }
        
        // 渲染任务列表
        function renderTasks() {
            if (tasks.length === 0) {
                taskList.innerHTML = '<div class="empty-state">暂无任务，添加你的第一个任务吧！</div>';
                return;
            }
            
            taskList.innerHTML = '';
            let completedCount = 0;
            
            // 按创建时间倒序排列
            const sortedTasks = [...tasks].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            sortedTasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                taskItem.setAttribute('data-id', task.id);
                
                const taskContent = document.createElement('div');
                taskContent.className = 'task-content';
                
                // 左侧部分：复选框和分类标签
                const leftSection = document.createElement('div');
                leftSection.className = 'task-left-section';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'task-checkbox';
                checkbox.checked = task.completed;
                checkbox.addEventListener('change', () => toggleTask(task.id));
                
                const categorySpan = document.createElement('span');
                categorySpan.className = `task-category category-${task.category}`;
                categorySpan.textContent = getCategoryName(task.category);
                
                leftSection.appendChild(checkbox);
                leftSection.appendChild(categorySpan);
                
                // 任务文本部分
                const textWrapper = document.createElement('div');
                textWrapper.className = 'task-text-wrapper';
                
                const taskText = document.createElement('span');
                taskText.className = `task-text ${task.completed ? 'completed' : ''}`;
                taskText.textContent = task.text;
                taskText.setAttribute('data-id', task.id);
                
                textWrapper.appendChild(taskText);
                
                // 组装任务内容区域
                taskContent.appendChild(leftSection);
                taskContent.appendChild(textWrapper);
                
                // 删除按钮
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i> 删除';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // 防止事件冒泡
                    deleteTask(task.id);
                });
                
                taskItem.appendChild(taskContent);
                taskItem.appendChild(deleteBtn);
                taskList.appendChild(taskItem);
                
                // 添加双击编辑事件
                taskItem.addEventListener('dblclick', (e) => {
                    if (e.target !== checkbox && e.target !== deleteBtn && e.target !== deleteBtn.querySelector('i')) {
                        editTask(task.id);
                    }
                });
                
                if (task.completed) completedCount++;
            });
        }
        
        // 渲染时间记录
        function renderLogs() {
            if (timeLogs.length === 0) {
                logList.innerHTML = '<div class="empty-state">暂无时间记录，开始记录你的工作时间吧！</div>';
                return;
            }
            
            logList.innerHTML = '';
            
            // 按日期和时间段排序（最近的在前）
            const sortedLogs = [...timeLogs].sort((a, b) => {
                // 首先按日期排序
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare !== 0) return dateCompare;
                
                // 如果日期相同，按创建时间排序
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            sortedLogs.forEach(log => {
                const logItem = document.createElement('div');
                logItem.className = 'log-item';
                logItem.setAttribute('data-id', log.id);
                
                const logContent = document.createElement('div');
                logContent.className = 'log-content';
                
                const logHeader = document.createElement('div');
                logHeader.className = 'log-header';
                
                const datePeriod = document.createElement('div');
                datePeriod.className = 'log-date-period';
                
                const date = document.createElement('div');
                date.className = 'log-date';
                date.innerHTML = `<i class="far fa-calendar"></i> ${log.formattedDate || log.date}`;
                date.setAttribute('data-id', log.id);
                
                const period = document.createElement('div');
                period.className = 'time-period';
                period.innerHTML = `<i class="far fa-clock"></i> ${log.period}`;
                period.setAttribute('data-id', log.id);
                
                datePeriod.appendChild(date);
                datePeriod.appendChild(period);
                
                const work = document.createElement('div');
                work.className = 'log-work';
                work.textContent = log.content;
                work.setAttribute('data-id', log.id);
                
                datePeriod.appendChild(period);
                logHeader.appendChild(datePeriod);
                logContent.appendChild(logHeader);
                logContent.appendChild(work);
                
                if (log.details) {
                    const details = document.createElement('div');
                    details.className = 'log-details';
                    details.textContent = log.details;
                    details.setAttribute('data-id', log.id);
                    logContent.appendChild(details);
                }
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i> 删除';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // 防止事件冒泡
                    deleteLog(log.id);
                });
                
                logItem.appendChild(logContent);
                logItem.appendChild(deleteBtn);
                logList.appendChild(logItem);
                
                // 添加双击编辑事件到整个日志项
                logItem.addEventListener('dblclick', (e) => {
                    if (e.target !== deleteBtn && e.target !== deleteBtn.querySelector('i')) {
                        const target = e.target;
                        const logId = log.id;
                        
                        if (target.classList.contains('log-date')) {
                            editLogDate(logId);
                        } else if (target.classList.contains('time-period')) {
                            editLogPeriod(logId);
                        } else if (target.classList.contains('log-work')) {
                            editLogContent(logId);
                        } else if (target.classList.contains('log-details')) {
                            editLogDetails(logId);
                        } else {
                            // 如果点击的是其他部分，默认编辑工作内容
                            editLogContent(logId);
                        }
                    }
                });
            });
        }
        
        // 切换任务完成状态
        function toggleTask(id) {
            tasks = tasks.map(task => {
                if (task.id === id) {
                    return { ...task, completed: !task.completed };
                }
                return task;
            });
            
            saveTasks();
            renderTasks();
        }
        
        // 删除任务
        function deleteTask(id) {
            if (confirm('确定要删除这个任务吗？')) {
                tasks = tasks.filter(task => task.id !== id);
                saveTasks();
                renderTasks();
            }
        }
        
        // 删除时间记录
        function deleteLog(id) {
            if (confirm('确定要删除这条记录吗？')) {
                timeLogs = timeLogs.filter(log => log.id !== id);
                saveLogs();
                renderLogs();
            }
        }
        
        // 编辑任务
        function editTask(id) {
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            
            const taskItem = document.querySelector(`.task-item[data-id="${id}"]`);
            if (!taskItem) return;
            
            // 保存原始内容
            const originalText = task.text;
            const originalCategory = task.category;
            
            // 标记为编辑模式
            taskItem.classList.add('editing-mode');
            
            // 获取当前显示的内容
            const taskText = taskItem.querySelector('.task-text');
            const categorySpan = taskItem.querySelector('.task-category');
            const deleteBtn = taskItem.querySelector('.delete-btn');
            
            // 保存原始HTML
            const originalTaskContent = taskItem.querySelector('.task-content').innerHTML;
            
            // 创建编辑界面
            const editContainer = document.createElement('div');
            editContainer.style.width = '100%';
            editContainer.style.padding = '10px';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'edit-input';
            input.value = task.text;
            input.style.marginBottom = '10px';
            input.style.width = '100%';
            
            const categorySelect = document.createElement('select');
            categorySelect.className = 'edit-select';
            categorySelect.style.width = '100%';
            categorySelect.style.marginBottom = '10px';
            
            const categories = [
                { value: 'work', name: '工作' },
                { value: 'life', name: '生活' },
                { value: 'study', name: '学习' }
            ];
            
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.value;
                option.textContent = cat.name;
                if (cat.value === task.category) option.selected = true;
                categorySelect.appendChild(option);
            });
            
            const editControls = document.createElement('div');
            editControls.className = 'edit-controls';
            editControls.style.justifyContent = 'flex-end';
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'save-edit-btn';
            saveBtn.textContent = '保存';
            saveBtn.addEventListener('click', () => {
                const newText = input.value.trim();
                if (!newText) {
                    alert('任务内容不能为空');
                    return;
                }
                
                tasks = tasks.map(t => {
                    if (t.id === id) {
                        return { ...t, text: newText, category: categorySelect.value };
                    }
                    return t;
                });
                
                saveTasks();
                renderTasks();
            });
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'cancel-edit-btn';
            cancelBtn.textContent = '取消';
            cancelBtn.addEventListener('click', () => {
                // 恢复原始数据
                tasks = tasks.map(t => {
                    if (t.id === id) {
                        return { ...t, text: originalText, category: originalCategory };
                    }
                    return t;
                });
                
                saveTasks();
                renderTasks();
            });
            
            editControls.appendChild(saveBtn);
            editControls.appendChild(cancelBtn);
            
            editContainer.appendChild(input);
            editContainer.appendChild(categorySelect);
            editContainer.appendChild(editControls);
            
            // 替换任务内容为编辑框
            taskItem.innerHTML = '';
            taskItem.appendChild(editContainer);
            
            // 焦点设置到输入框
            input.focus();
            input.select();
            
            // 添加键盘事件
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveBtn.click();
                }
            });
        }
        
        // 编辑时间记录日期
        function editLogDate(id) {
            const log = timeLogs.find(l => l.id === id);
            if (!log) return;
            
            const logItem = document.querySelector(`.log-item[data-id="${id}"]`);
            if (!logItem) return;
            
            // 保存原始数据
            const originalDate = log.date;
            const originalFormattedDate = log.formattedDate;
            
            // 标记为编辑模式
            logItem.classList.add('editing-mode');
            
            // 创建编辑界面
            const dateElement = logItem.querySelector('.log-date');
            const originalHTML = dateElement.innerHTML;
            
            const input = document.createElement('input');
            input.type = 'date';
            input.className = 'edit-input';
            input.value = log.date;
            input.style.width = '150px';
            
            const editControls = document.createElement('div');
            editControls.className = 'edit-controls';
            editControls.style.marginTop = '5px';
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'save-edit-btn';
            saveBtn.textContent = '保存';
            saveBtn.style.padding = '5px 10px';
            saveBtn.style.fontSize = '0.8rem';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'cancel-edit-btn';
            cancelBtn.textContent = '取消';
            cancelBtn.style.padding = '5px 10px';
            cancelBtn.style.fontSize = '0.8rem';
            
            editControls.appendChild(saveBtn);
            editControls.appendChild(cancelBtn);
            
            dateElement.innerHTML = '';
            dateElement.appendChild(input);
            dateElement.appendChild(editControls);
            
            input.focus();
            
            const handleSave = () => {
                const newDate = input.value;
                if (!newDate) {
                    alert('日期不能为空');
                    return;
                }
                
                // 格式化新日期
                const dateObj = new Date(newDate);
                const formattedDate = dateObj.toLocaleDateString('zh-CN', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'short'
                });
                
                timeLogs = timeLogs.map(l => {
                    if (l.id === id) {
                        return { ...l, date: newDate, formattedDate: formattedDate };
                    }
                    return l;
                });
                
                saveLogs();
                renderLogs();
            };
            
            const handleCancel = () => {
                // 恢复原始数据
                timeLogs = timeLogs.map(l => {
                    if (l.id === id) {
                        return { ...l, date: originalDate, formattedDate: originalFormattedDate };
                    }
                    return l;
                });
                
                saveLogs();
                renderLogs();
            };
            
            saveBtn.addEventListener('click', handleSave);
            cancelBtn.addEventListener('click', handleCancel);
            
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSave();
            });
        }
        
        // 编辑时间记录时间段
        function editLogPeriod(id) {
            const log = timeLogs.find(l => l.id === id);
            if (!log) return;
            
            const logItem = document.querySelector(`.log-item[data-id="${id}"]`);
            if (!logItem) return;
            
            const periodElement = logItem.querySelector('.time-period');
            const originalPeriod = log.period;
            
            // 标记为编辑模式
            logItem.classList.add('editing-mode');
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'edit-input';
            input.value = log.period;
            input.style.width = '150px';
            
            const editControls = document.createElement('div');
            editControls.className = 'edit-controls';
            editControls.style.marginTop = '5px';
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'save-edit-btn';
            saveBtn.textContent = '保存';
            saveBtn.style.padding = '5px 10px';
            saveBtn.style.fontSize = '0.8rem';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'cancel-edit-btn';
            cancelBtn.textContent = '取消';
            cancelBtn.style.padding = '5px 10px';
            cancelBtn.style.fontSize = '0.8rem';
            
            editControls.appendChild(saveBtn);
            editControls.appendChild(cancelBtn);
            
            periodElement.innerHTML = '';
            periodElement.appendChild(input);
            periodElement.appendChild(editControls);
            input.focus();
            
            const handleSave = () => {
                const newPeriod = input.value.trim();
                if (!newPeriod) {
                    alert('时间段不能为空');
                    return;
                }
                
                timeLogs = timeLogs.map(l => {
                    if (l.id === id) {
                        return { ...l, period: newPeriod };
                    }
                    return l;
                });
                
                saveLogs();
                renderLogs();
            };
            
            const handleCancel = () => {
                // 恢复原始数据
                timeLogs = timeLogs.map(l => {
                    if (l.id === id) {
                        return { ...l, period: originalPeriod };
                    }
                    return l;
                });
                
                saveLogs();
                renderLogs();
            };
            
            saveBtn.addEventListener('click', handleSave);
            cancelBtn.addEventListener('click', handleCancel);
            
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSave();
            });
        }
        
        // 编辑时间记录内容
        function editLogContent(id) {
            const log = timeLogs.find(l => l.id === id);
            if (!log) return;
            
            const logItem = document.querySelector(`.log-item[data-id="${id}"]`);
            if (!logItem) return;
            
            const contentElement = logItem.querySelector('.log-work');
            const originalContent = log.content;
            
            // 标记为编辑模式
            logItem.classList.add('editing-mode');
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'edit-input';
            input.value = log.content;
            input.style.width = '100%';
            
            const editControls = document.createElement('div');
            editControls.className = 'edit-controls';
            editControls.style.marginTop = '5px';
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'save-edit-btn';
            saveBtn.textContent = '保存';
            saveBtn.style.padding = '5px 10px';
            saveBtn.style.fontSize = '0.8rem';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'cancel-edit-btn';
            cancelBtn.textContent = '取消';
            cancelBtn.style.padding = '5px 10px';
            cancelBtn.style.fontSize = '0.8rem';
            
            editControls.appendChild(saveBtn);
            editControls.appendChild(cancelBtn);
            
            contentElement.innerHTML = '';
            contentElement.appendChild(input);
            contentElement.appendChild(editControls);
            input.focus();
            input.select();
            
            const handleSave = () => {
                const newContent = input.value.trim();
                if (!newContent) {
                    alert('工作内容不能为空');
                    return;
                }
                
                timeLogs = timeLogs.map(l => {
                    if (l.id === id) {
                        return { ...l, content: newContent };
                    }
                    return l;
                });
                
                saveLogs();
                renderLogs();
            };
            
            const handleCancel = () => {
                // 恢复原始数据
                timeLogs = timeLogs.map(l => {
                    if (l.id === id) {
                        return { ...l, content: originalContent };
                    }
                    return l;
                });
                
                saveLogs();
                renderLogs();
            };
            
            saveBtn.addEventListener('click', handleSave);
            cancelBtn.addEventListener('click', handleCancel);
            
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSave();
            });
        }
        
        // 编辑时间记录详情
        function editLogDetails(id) {
            const log = timeLogs.find(l => l.id === id);
            if (!log) return;
            
            const logItem = document.querySelector(`.log-item[data-id="${id}"]`);
            if (!logItem) return;
            
            const detailsElement = logItem.querySelector('.log-details');
            const originalDetails = log.details;
            
            // 标记为编辑模式
            logItem.classList.add('editing-mode');
            
            const textarea = document.createElement('textarea');
            textarea.className = 'edit-textarea';
            textarea.value = log.details || '';
            textarea.style.width = '100%';
            textarea.style.minHeight = '100px';
            
            const editControls = document.createElement('div');
            editControls.className = 'edit-controls';
            editControls.style.marginTop = '10px';
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'save-edit-btn';
            saveBtn.textContent = '保存';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'cancel-edit-btn';
            cancelBtn.textContent = '取消';
            
            editControls.appendChild(saveBtn);
            editControls.appendChild(cancelBtn);
            
            detailsElement.innerHTML = '';
            detailsElement.appendChild(textarea);
            detailsElement.appendChild(editControls);
            textarea.focus();
            
            const handleSave = () => {
                const newDetails = textarea.value; // 保留换行符，不trim
                
                timeLogs = timeLogs.map(l => {
                    if (l.id === id) {
                        return { ...l, details: newDetails };
                    }
                    return l;
                });
                
                saveLogs();
                renderLogs();
            };
            
            const handleCancel = () => {
                // 恢复原始数据
                timeLogs = timeLogs.map(l => {
                    if (l.id === id) {
                        return { ...l, details: originalDetails };
                    }
                    return l;
                });
                
                saveLogs();
                renderLogs();
            };
            
            saveBtn.addEventListener('click', handleSave);
            cancelBtn.addEventListener('click', handleCancel);
        }
        
        // 清除所有任务
        function clearAllTasks() {
            if (tasks.length === 0) {
                alert('当前没有任务可以清除');
                return;
            }
            
            if (confirm('确定要清除所有任务吗？此操作不可撤销！')) {
                tasks = [];
                saveTasks();
                renderTasks();
                alert('所有任务已清除');
            }
        }
        
        // 清除所有时间记录
        function clearAllLogs() {
            if (timeLogs.length === 0) {
                alert('当前没有时间记录可以清除');
                return;
            }
            
            if (confirm('确定要清除所有时间记录吗？此操作不可撤销！')) {
                timeLogs = [];
                saveLogs();
                renderLogs();
                alert('所有时间记录已清除');
            }
        }
        
        // 获取分类名称
        function getCategoryName(category) {
            switch(category) {
                case 'work': return '工作';
                case 'life': return '生活';
                case 'study': return '学习';
                default: return '工作';
            }
        }
        
        // 保存任务到本地存储
        function saveTasks() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }
        
        // 保存时间记录到本地存储
        function saveLogs() {
            localStorage.setItem('timeLogs', JSON.stringify(timeLogs));
        }
        
        // 导出数据到Excel
        function exportToExcel() {
            // 准备任务数据
            const tasksData = tasks.map(task => ({
                '任务内容': task.text,
                '分类': getCategoryName(task.category),
                '状态': task.completed ? '已完成' : '未完成',
                '创建时间': new Date(task.createdAt).toLocaleString('zh-CN')
            }));
            
            // 准备时间记录数据
            const logsData = timeLogs.map(log => ({
                '日期': log.date,
                '时间段': log.period,
                '工作内容': log.content,
                '详细描述': log.details || '',
                '记录时间': new Date(log.createdAt).toLocaleString('zh-CN')
            }));
            
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            
            // 创建工作表
            const tasksWs = XLSX.utils.json_to_sheet(tasksData);
            const logsWs = XLSX.utils.json_to_sheet(logsData);
            
            // 设置列宽
            const tasksColWidths = [
                { wch: 40 }, // 任务内容
                { wch: 10 }, // 分类
                { wch: 15 }, // 状态
                { wch: 25 }  // 创建时间
            ];
            
            const logsColWidths = [
                { wch: 15 }, // 日期
                { wch: 20 }, // 时间段
                { wch: 40 }, // 工作内容
                { wch: 50 }, // 详细描述
                { wch: 25 }  // 记录时间
            ];
            
            tasksWs['!cols'] = tasksColWidths;
            logsWs['!cols'] = logsColWidths;
            
            // 将工作表添加到工作簿
            XLSX.utils.book_append_sheet(wb, tasksWs, '任务列表');
            XLSX.utils.book_append_sheet(wb, logsWs, '工作时间记录');
            
            // 生成Excel文件并下载
            const fileName = `任务与时间记录_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            alert('数据导出成功！文件已下载。');
        }
        
        // 从Excel导入数据
        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('导入数据将覆盖当前所有任务和时间记录，确定要继续吗？')) {
                importFile.value = '';
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 清空当前数据
                    tasks = [];
                    timeLogs = [];
                    
                    // 解析任务数据
                    if (workbook.Sheets['任务列表']) {
                        const tasksSheet = workbook.Sheets['任务列表'];
                        const tasksJson = XLSX.utils.sheet_to_json(tasksSheet);
                        
                        tasksJson.forEach(item => {
                            let category = 'work';
                            if (item['分类'] === '生活') category = 'life';
                            else if (item['分类'] === '学习') category = 'study';
                            
                            const newTask = {
                                id: Date.now() + Math.random(),
                                text: item['任务内容'] || item['任务'] || '',
                                category: category,
                                completed: (item['状态'] === '已完成' || item['完成状态'] === '已完成') ? true : false,
                                createdAt: item['创建时间'] ? new Date(item['创建时间']).toISOString() : new Date().toISOString()
                            };
                            tasks.push(newTask);
                        });
                    }
                    
                    // 解析时间记录数据
                    if (workbook.Sheets['工作时间记录']) {
                        const logsSheet = workbook.Sheets['工作时间记录'];
                        const logsJson = XLSX.utils.sheet_to_json(logsSheet);
                        
                        logsJson.forEach(item => {
                            // 格式化日期显示
                            let dateValue = item['日期'];
                            let formattedDate = '';
                            
                            if (dateValue) {
                                try {
                                    const dateObj = new Date(dateValue);
                                    formattedDate = dateObj.toLocaleDateString('zh-CN', { 
                                        year: 'numeric', 
                                        month: 'long', 
                                        day: 'numeric',
                                        weekday: 'short'
                                    });
                                } catch (e) {
                                    formattedDate = dateValue;
                                }
                            }
                            
                            const newLog = {
                                id: Date.now() + Math.random(),
                                date: dateValue || new Date().toISOString().split('T')[0],
                                formattedDate: formattedDate,
                                period: item['时间段'] || '',
                                content: item['工作内容'] || '',
                                details: item['详细描述'] || '',
                                createdAt: item['记录时间'] ? new Date(item['记录时间']).toISOString() : new Date().toISOString()
                            };
                            timeLogs.push(newLog);
                        });
                    }
                    
                    // 保存并重新渲染
                    saveTasks();
                    saveLogs();
                    renderTasks();
                    renderLogs();
                    
                    alert(`数据导入成功！\n导入了 ${tasks.length} 个任务和 ${timeLogs.length} 条时间记录。`);
                    importFile.value = '';
                    
                } catch (error) {
                    alert('导入失败，请确保文件格式正确或检查Excel文件内容');
                    console.error(error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // 添加示例数据（第一次使用时）
        if (!localStorage.getItem('hasExampleData')) {
            tasks = [
                { id: 1, text: '完成项目需求文档，这是一个非常长的任务内容用于测试文本换行和布局效果', category: 'work', completed: true, createdAt: new Date().toISOString() },
                { id: 2, text: '团队周会，讨论本周工作进展和下周计划安排', category: 'work', completed: false, createdAt: new Date().toISOString() },
                { id: 3, text: '学习React框架，包括组件生命周期、状态管理和Hooks等高级特性', category: 'study', completed: false, createdAt: new Date().toISOString() },
                { id: 4, text: '健身房锻炼，包括有氧运动和力量训练', category: 'life', completed: false, createdAt: new Date().toISOString() }
            ];
            
            // 添加示例时间记录（包含日期）
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const formatDate = (date) => {
                return date.toLocaleDateString('zh-CN', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'short'
                });
            };
            
            timeLogs = [
                { 
                    id: 1, 
                    date: today.toISOString().split('T')[0],
                    formattedDate: formatDate(today),
                    period: '9:00-10:30', 
                    content: '完成项目需求分析', 
                    details: '与产品经理讨论功能需求\n明确项目目标\n制定开发计划',
                    createdAt: new Date().toISOString() 
                },
                { 
                    id: 2, 
                    date: today.toISOString().split('T')[0],
                    formattedDate: formatDate(today),
                    period: '10:45-12:00', 
                    content: '设计数据库结构', 
                    details: '创建ER图\n定义数据表关系\n确定索引策略',
                    createdAt: new Date().toISOString() 
                },
                { 
                    id: 3, 
                    date: yesterday.toISOString().split('T')[0],
                    formattedDate: formatDate(yesterday),
                    period: '14:00-16:30', 
                    content: '学习新技术框架', 
                    details: '研究Vue 3.0的新特性\n编写示例代码\n整理学习笔记',
                    createdAt: new Date().toISOString() 
                }
            ];
            
            saveTasks();
            saveLogs();
            localStorage.setItem('hasExampleData', 'true');
            
            renderTasks();
            renderLogs();
        }
    </script>
</body>
</html>
